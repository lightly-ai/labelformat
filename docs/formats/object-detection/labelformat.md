# Labelformat Object Detection Format

## Overview
The Labelformat format provides an in-memory representation for object detection detections. It's designed for programmatic creation and manipulation of label data within Python scripts. This format is particularly useful when you need to convert detections generated by custom models or dataloaders into a standardized structure before potentially converting them to other file-based formats supported by `labelformat`.

## Specification of Labelformat Detection Format
The format is defined by the `LabelformatObjectDetectionInput` dataclass in `labelformat.formats.labelformat`. It holds the following information directly in Python objects:

- `categories`: A list of `Category` objects, each containing `id` and `name`.
- `images`: A list of `Image` objects, each containing `id`, `filename`, `width`, and `height`.
- `detections`: A list of `ImageObjectDetection` objects. Each object links an `Image` to a list of `SingleObjectDetection` instances.
  - `SingleObjectDetection` contains:
    - `category`: The `Category` object for the detection.
    - `box`: A `BoundingBox` object representing the location (can be created from various formats like XYXY, XYWH, CXCYWH).
    - `confidence`: An optional float score (0-1).

**Note:** This format is primarily intended for programmatic use and does not support direct loading from files via the CLI using `add_cli_arguments`. It serves as a flexible in-memory structure.

## Example Usage (Programmatic Creation)
```python
from labelformat.formats.labelformat import LabelformatObjectDetectionInput
from labelformat.model.bounding_box import BoundingBox, BoundingBoxFormat
from labelformat.model.category import Category
from labelformat.model.image import Image
from labelformat.model.object_detection import (
    ImageObjectDetection,
    SingleObjectDetection,
)

# Assume you have:
# my_dataloader: An iterable yielding (PILImage, filename)
# my_model: A model with a .predict() method and .get_categories()
# prediction_bbox_format: The format of your model's output boxes ("xyxy", "xywh", etc.)

categories = [
    Category(id=i, name=category_name)
    for i, category_name in enumerate(my_model.get_categories())
]
category_map = {cat.name: cat for cat in categories} # Or map by index if model outputs index

images = []
detections = []
image_id_counter = 0

for pil_image, filename in my_dataloader:
    # Create Image object
    current_image = Image(
        id=image_id_counter,
        filename=filename,
        width=pil_image.width,
        height=pil_image.height
    )
    images.append(current_image)

    # Get model predictions
    # Assuming predictions is a list of dicts like:
    # [{'box': [x, y, w, h], 'category_id': 0, 'confidence': 0.9}]
    model_predictions = my_model.predict(pil_image)

    # Create SingleObjectDetection objects
    objects = []
    for pred in model_predictions:
        objects.append(
            SingleObjectDetection(
                # Ensure you correctly map prediction category to Category object
                category=categories[pred['category_id']],
                box=BoundingBox.from_format(
                    box=pred['box'],
                    format=BoundingBoxFormat(prediction_bbox_format), # Use BoundingBoxFormat enum
                ),
                confidence=pred.get('confidence'), # Use .get for optional confidence
            )
        )

    # Create ImageObjectDetection object
    detections.append(
        ImageObjectDetection(
            image=current_image,
            objects=objects,
        )
    )
    image_id_counter += 1

# Create the final input object
labelformat_input = LabelformatObjectDetectionInput(
    categories=categories,
    images=images,
    labels=detections,
)

# Now labelformat_input can be used, e.g., to convert to another format:
# from labelformat.formats.lightly import LightlyObjectDetectionOutput
# output_converter = LightlyObjectDetectionOutput(output_folder="path/to/lightly_output")
# output_converter.save(labelformat_input)

```
